package com.shoppin.ecommerce.service;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.shoppin.ecommerce.model.CartModel;
import com.shoppin.ecommerce.model.CustomerModel;
import com.shoppin.ecommerce.model.OrderEntryModel;
import com.shoppin.ecommerce.model.OrderModel;
import com.shoppin.ecommerce.model.OrderStatus;
import com.shoppin.ecommerce.repo.CartRepository;
import com.shoppin.ecommerce.repo.CustomerRepository;
import com.shoppin.ecommerce.repo.OrderRepository;

@Service
public class OrderService {
	
	@Autowired
	OrderRepository orderRepository;
	
	@Autowired
	CustomerRepository customerRepository;
	
	@Autowired
	CartRepository cartRepository;

	public ResponseEntity<Object> placeOrder(String username, CartModel cart){
		
		try {
			
			if(!cart.isPaymentCompleted()) {
				return ResponseEntity.status(402).body("Something went wrong while placing order due to payment");
			}
			
			CustomerModel customer = customerRepository.findByEmail(username).orElse(null);
			OrderModel order = new OrderModel();
			
			order.setUser(customer);
			order.setDeliveryAddress(cart.getDeliveryAddress());
			order.setPaymentAddress(cart.getPaymentAddress());
			order.setOrderEntries(new ArrayList<OrderEntryModel>());
			//order.setOrderEntries(setOrderEntryModel(cartModel));
			order.setOrderNumber(generateOrderCode());
			order.setStatus(OrderStatus.WAITING);
			order.setPaymentCompleted(true);
			order.setTotalPrice(cart.getTotalPrice());
			order.setPaymentMethod(cart.getPaymentMethod());
			
			orderRepository.save(order);
			
			//return ResponseEntity.status(201).body("Order Created:"+order.getOrderNumber());
			return ResponseEntity.status(201).body(order);
			
		}catch(Exception e) {
			return ResponseEntity.status(500).body("Something went wrong while placing order\n"+ e);
		}
	}
	
	private String generateOrderCode() {
		
		String order = orderRepository.findTopOrderNumberByOrderByCreatedTimeDesc().orElse(null);
		
		DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyyMMdd");
		LocalDate todayDateTime = LocalDate.now();
		
		String today = todayDateTime.format(formatter);
		
		if(order==null) {
			return today+"-0001";
		}
		
		Integer lastOrder = Integer.parseInt(order.substring(8));
		
		String current = today+"-"+String.valueOf(lastOrder+1);
		
		return current;
		
	}
}
